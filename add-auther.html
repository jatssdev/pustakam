<script src="./assets/js/apis/auth.js"></script>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/finalLogo.jpeg">
    <link rel="icon" type="image/png" href="./assets/img/finalLogo.jpeg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title data-translate="logotxt">Pustakam</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="./assets/css/paper-dashboard.css?v=2.0.1" rel="stylesheet" />
    <link href="./assets/demo/demo.css" rel="stylesheet" />
    <style>
        @media (max-width: 991px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 1040;
                height: 100%;
                background-color: #fff;
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                display: block;
                transform: translateX(0);
            }

            .main-panel {
                padding-left: 0;
            }

            .navbar-toggler {
                display: inline-block;
            }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-color="white" data-active-color="danger">
            <div class="logo">
                <a href="/" class="simple-text logo-mini">
                    <div class="logo-image-small">
                        <img src="./assets/img/finalLogo.jpeg">
                    </div>
                </a>
                <a href="/" class="simple-text logo-normal" data-translate="logotxt">Pustakam</a>
            </div>
            <div class="sidebar-wrapper">
                <ul class="nav">
                    <li>
                        <a href="/">
                            <i class="nc-icon nc-bank"></i>
                            <p data-translate="dashboard">Dashboard</p>
                        </a>
                    </li>
                    <li>
                        <a href="./topics.html">
                            <i class="fa fa-folder"></i>
                            <p data-translate="topics">Topics</p>
                        </a>
                    </li>
                    <li>
                        <a href="./authers.html">
                            <i class="fa-solid fa-users"></i>
                            <p data-translate="authors">Authors</p>
                        </a>
                    </li>
                    <li><a href="./books.html"><i class="fa fa-book"></i>
                            <p data-translate="books">Books</p>
                        </a></li>
                    <li>
                        <a href="./languages.html">
                            <i class="fa fa-language"></i>
                            <p data-translate="languages">Languages</p>
                        </a>
                    </li>
                    <li>
                        <a href="./advertise.html">
                            <i class="fas fa-ad"></i>
                            <p data-translate="advertisement">Advertisement</p>
                        </a>
                    </li>
                    <li>
                        <a onclick="Logout()">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <p data-translate="logout">Logout</p>
                        </a>
                    </li>

                </ul>
            </div>
        </div>

        <div class="main-panel">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
                <div class="container-fluid">
                    <select id="language-dropdown" class="form-control"
                        style="width: auto; display: inline-block; margin-right: 15px;">
                        <option value="en" data-translate="optionenglish">English</option>
                        <option value="hi" data-translate="optionhindi">Hindi</option>
                    </select>
                    <div class="navbar-wrapper">
                        <a class="navbar-brand" href="javascript:;" data-translate="dashboard">Add Author</a>
                    </div>
                    <div class="navbar-toggle">
                        <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
                            <span class="navbar-toggler-bar bar1"></span>
                            <span class="navbar-toggler-bar bar2"></span>
                            <span class="navbar-toggler-bar bar3"></span>
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Page Content -->
            <div class="content" style="min-height: 75vh;">
                <div class="container">
                    <h2 class="my-4" data-translate="add_author">Add Author</h2>
                    <form id="authorForm">
                        <div id="changeOrderParent" class="d-flex">
                            <div class="form-group order-1">
                                <label for="authorEnglish" data-translate="author_english">Author Name (English)</label>
                                <input type="text" id="authorEnglish" class="form-control"
                                    placeholder="Enter author name in English" required>
                            </div>
                            <div class="form-group order-2">
                                <label for="authorHindi" data-translate="author_hindi">Author Name (Hindi)</label>
                                <input type="text" id="authorHindi" class="form-control"
                                    placeholder="Enter author name in Hindi" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="topicSelect" data-translate="topic">Select Topic</label>
                            <select id="topicSelect" class="form-control">
                                <option value="" disabled selected data-translate="selectTopicText">Select a topic
                                </option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" data-translate="add_author">Add Author</button>
                    </form>
                    <div id="message" class="mt-3"></div>
                </div>
            </div>

            <footer class="footer footer-black footer-white">
                <div class="container-fluid">
                    <hr>
                    <div class="row">
                        <div class="credits mx-auto">
                            <span class="copyright">
                                ©
                                <script>document.write(new Date().getFullYear())</script>, <span
                                    data-translate="copyright">All rights reserved by Pustakam</span>
                            </span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Core JS Files -->
    <script src="./assets/js/core/jquery.min.js"></script>
    <script src="./assets/js/core/popper.min.js"></script>
    <script src="./assets/js/core/bootstrap.min.js"></script>
    <script>

        function Logout() {
            localStorage.removeItem('loggedadmin')
            location.href = '/login.html'
        }

        let changeOrderParentHandler = () => {
            let changeOrderParent = document.getElementById('changeOrderParent');

            let currLanguage = localStorage.getItem('language') || 'en'

            if (currLanguage === 'hi') {
                changeOrderParent.style.flexDirection = 'column-reverse'
            } else {
                changeOrderParent.style.flexDirection = 'column'
            }
        }
        changeOrderParentHandler()
        // Language JSON and translation function
        let englishJson = {
            "optionenglish": "English", "optionhindi": "Hindi", "logotxt": "Pustakam", "dashboard": "Dashboard", "authors": "Authors", "topics": "Topics", "checkout_details": "Checkout Details", "add_author": "Add Author",
            "author_english": "Author Name (English)", "author_hindi": "Author Name (Hindi)", "topic": "Select Topic", "copyright": "All rights reserved by Pustakam",
            "books": "Books", "languages": "Languages", "logout": "Logout",
            "placeholder_author_english": "Enter author name in English",
            "placeholder_author_hindi": "Enter author name in Hindi",
            "selectTopicText": "Select a topic",
        };

        let hindiJson = {
            "optionenglish": "अंग्रेज़ी", "optionhindi": "हिंदी", "logotxt": "पुस्तकम", "dashboard": "डैशबोर्ड", "authors": "लेखक", "topics": "श्रेणियाँ", "checkout_details": "विवरण देखें", "add_author": "लेखक जोड़ें",
            "author_english": "लेखक का नाम (अंग्रेज़ी)", "author_hindi": "लेखक का नाम (हिंदी)", "topic": "श्रेणी चुनें", "copyright": "सभी अधिकार पुस्तकम द्वारा सुरक्षित",
            "books": "पुस्तकें", "languages": "भाषाएँ", "logout": "लॉग आउट",
            "placeholder_author_english": "अंग्रेज़ी में लेखक का नाम दर्ज करें",
            "placeholder_author_hindi": "हिंदी में लेखक का नाम दर्ज करें",
            "selectTopicText": "श्रेणी चुनें"

        };

        const fieldMappings = [
            { sourceFieldId: "authorEnglish", targetFieldId: "authorHindi", sourceLang: "en", targetLang: "hi" },
            // Add more mappings as needed
        ];
        const fieldMappingsHindi = [
            { sourceFieldId: "authorHindi", targetFieldId: "authorEnglish", sourceLang: "hi", targetLang: "en" },
            // Add more mappings as needed
        ];
        function loadLanguage(language) {
            let translations = language === 'hi' ? hindiJson : englishJson;
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                element.textContent = translations[key] || key;
            });

            // Update placeholders for author name fields
            const authorEnglishInput = document.getElementById('authorEnglish');
            const authorHindiInput = document.getElementById('authorHindi');

            if (authorEnglishInput && translations["placeholder_author_english"]) {
                authorEnglishInput.placeholder = translations["placeholder_author_english"];
            }

            if (authorHindiInput && translations["placeholder_author_hindi"]) {
                authorHindiInput.placeholder = translations["placeholder_author_hindi"];
            }
        }

        document.getElementById('language-dropdown').addEventListener('change', function () {
            const selectedLanguage = this.value;

            // Set the selected language in localStorage
            localStorage.setItem('language', selectedLanguage);

            // Load the selected language
            loadLanguage(selectedLanguage);

            // Get the updated language from localStorage
            const language = localStorage.getItem('language') || 'en';

            // Decide which field mappings to use based on the selected language
            let fieldMappingsData = language === 'en' ? fieldMappings : fieldMappingsHindi;

            // Handle language change with the field mappings

            // Ensure changeOrderParentHandler runs after other operations
            languagesChangHandler(fieldMappingsData);
            setTimeout(() => {
                changeOrderParentHandler();

            }, 0);
        });

        // Map English fields to their Hindi counterparts

        document.addEventListener('DOMContentLoaded', () => {
            const language = localStorage.getItem('language') || 'en';
            document.getElementById('language-dropdown').value = language;
            loadLanguage(language);
            fetchTopics();
            let fieldMappingsData = language === 'en' ? fieldMappings : fieldMappingsHindi
            languagesChangHandler(fieldMappingsData)

        });

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('show');
        }

        // Close sidebar on outside click
        document.addEventListener('click', function (e) {
            const sidebar = document.querySelector('.sidebar');
            const target = e.target;
            const isSidebarClicked = sidebar.contains(target);
            const isNavbarTogglerClicked = target.closest('.navbar-toggler');
            if (!isSidebarClicked && !isNavbarTogglerClicked && window.innerWidth <= 991) {
                sidebar.classList.remove('show');
            }
        });

        // Fetch and populate topics
        async function fetchTopics() {
            try {
                const response = await fetch('https://pustakam.pythonanywhere.com/topic/');
                const data = await response.json();
                const topicSelect = document.getElementById('topicSelect');

                data.data.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = `${topic.topic_english} (${topic.topic_hindi})`;
                    topicSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching topics:', error);
            }
        }

        document.getElementById('authorForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            // Get the input values
            const authorEnglish = document.getElementById('authorEnglish').value;
            const authorHindi = document.getElementById('authorHindi').value;
            const topicId = document.getElementById('topicSelect').value;

            const messageDiv = document.getElementById('message');

            try {
                // Fetch all authors to check for duplicates
                const response = await fetch('https://pustakam.pythonanywhere.com/author/');
                const result = await response.json();

                if (result.status === "success") {
                    const existingAuthors = result.data;

                    // Check if the author already exists (either English or Hindi)
                    const isAuthorExist = existingAuthors.some(author =>
                        author.author_english.toLowerCase() === authorEnglish.toLowerCase() ||
                        author.author_hindi.toLowerCase() === authorHindi.toLowerCase()
                    );

                    if (isAuthorExist) {
                        // Show error message if author already exists
                        messageDiv.innerHTML = `<div class="alert alert-danger">Author already exists!</div>`;
                        setTimeout(() => {
                            messageDiv.innerHTML = '';
                        }, 3000);
                        return; // Prevent form submission
                    }

                    // Proceed with adding the new author if no duplicates found
                    const data = {
                        author_english: authorEnglish,
                        author_hindi: authorHindi,
                        topic_data: parseInt(topicId)
                    };

                    if (!data.topic_data) {
                        delete data.topic_data
                    }

                    const addAuthorResponse = await fetch('https://pustakam.pythonanywhere.com/author/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const addAuthorResult = await addAuthorResponse.json();


                    if (addAuthorResult.status == 'success') {
                        messageDiv.innerHTML = '<div class="alert alert-success">Author added successfully!</div>';
                        document.getElementById('authorForm').reset();
                        location.href = '/authers.html'
                    } else {
                        messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${addAuthorResult.message || 'Failed to add author'}</div>`;
                    }

                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.message || 'Failed to fetch authors'}</div>`;
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            }
        });



        const googleTranslateAPIKey = 'AIzaSyBlk5ZotGsdHMkbjPNarkmr9b3FV5n8vDo';

        // Function to call Google Translate API
        async function translateText(text, sourceLang, targetLang) {
            const url = `https://translation.googleapis.com/language/translate/v2?key=${googleTranslateAPIKey}`;
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        q: text, // The text to translate
                        source: sourceLang, // Source language
                        target: targetLang, // Target language
                        format: "text", // Plain text format
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                if (
                    data &&
                    data.data &&
                    data.data.translations &&
                    data.data.translations[0]
                ) {
                    return data.data.translations[0].translatedText;
                } else {
                    throw new Error("Translation failed. Invalid response structure.");
                }
            } catch (error) {
                console.error("Translation API error:", error);
                return text; // Fallback: return original text if translation fails
            }
        }

        // Debounce function to limit API calls
        function debounce(func, delay) {
            let debounceTimer;
            return function (...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }


        let activeListeners = []; // Track active event listeners

        let languagesChangHandler = (languageData) => {
            // Remove all active listeners first
            activeListeners.forEach(({ element, handler }) => {
                element.removeEventListener("input", handler);
            });
            activeListeners = []; // Reset the active listeners array

            // Add new event listeners for the selected language
            languageData.forEach(({ sourceFieldId, targetFieldId, sourceLang, targetLang }) => {
                const sourceField = document.getElementById(sourceFieldId);
                const targetField = document.getElementById(targetFieldId);

                if (sourceField && targetField) {
                    // Create a debounced handler
                    const handler = debounce(async function () {
                        const translatedText = await translateText(sourceField.value, sourceLang, targetLang);
                        targetField.value = translatedText;
                    }, 500);

                    // Add the listener
                    sourceField.addEventListener("input", handler);

                    // Track the listener to allow removal later
                    activeListeners.push({ element: sourceField, handler });
                }
            });
        };

        // Get the author fields
        const authorEnglishInput = document.getElementById('authorEnglish');
        const authorHindiInput = document.getElementById('authorHindi');

        // Regular expression to allow only alphabetic characters and spaces
        const validNamePattern = /^[A-Za-z\s]*$/;

        // Function to handle validation immediately when the user types
        function validateAuthorInput(event) {
            const inputField = event.target;
            let inputValue = inputField.value;

            // Check for invalid characters (non-alphabetic and non-space)
            if (!validNamePattern.test(inputValue)) {
                // Show the tooltip with a message
                inputField.setCustomValidity('Author name should only contain letters and spaces.');
                inputField.reportValidity(); // Display the error message

                // Remove invalid characters (anything that is not a letter or space)
                inputValue = inputValue.replace(/[^A-Za-z\s]/g, ''); // Remove special characters and numbers
                inputField.value = inputValue; // Update the input value without invalid characters
            } else {
                // Clear the error if the input is valid
                inputField.setCustomValidity('');
            }
        }

        // Attach event listeners to both author name fields
        authorEnglishInput.addEventListener('input', validateAuthorInput);
        authorHindiInput.addEventListener('input', validateAuthorInput);
    </script>
</body>

</html>