<script src="./assets/js/apis/auth.js"></script>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/finalLogo.jpeg">
    <link rel="icon" type="image/png" href="./assets/img/finalLogo.jpeg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title data-translate="logotxt">Pustakam</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="./assets/css/paper-dashboard.css?v=2.0.1" rel="stylesheet" />
    <link href="./assets/demo/demo.css" rel="stylesheet" />
    <style>
        /* Sidebar styling for visibility on smaller screens */
        @media (max-width: 991px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 1040;
                height: 100%;
                background-color: #fff;
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                display: block;
                transform: translateX(0);
            }

            .main-panel {
                padding-left: 0;
            }

            .navbar-toggler {
                display: inline-block;
            }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-color="white" data-active-color="danger">
            <div class="logo">
                <a href="/" class="simple-text logo-mini">
                    <div class="logo-image-small">
                        <img src="./assets/img/finalLogo.jpeg">
                    </div>
                </a>
                <a href="/" class="simple-text logo-normal" data-translate="logotxt">Pustakam</a>
            </div>
            <div class="sidebar-wrapper">
                <ul class="nav">
                    <li>
                        <a href="/">
                            <i class="nc-icon nc-bank"></i>
                            <p data-translate="dashboard">Dashboard</p>
                        </a>
                    </li>
                    <li>
                        <a href="./topics.html">
                            <i class="fa fa-folder"></i>
                            <p data-translate="topics">Topics</p>
                        </a>
                    </li>
                    <li>
                        <a href="./authers.html">
                            <i class="fa-solid fa-users"></i>
                            <p data-translate="authors">Authors</p>
                        </a>
                    </li>
                    <li><a href="./books.html"><i class="fa fa-book"></i>
                            <p data-translate="books">Books</p>
                        </a></li>
                    <li>
                        <a href="./languages.html">
                            <i class="fa fa-language"></i>
                            <p data-translate="languages">Languages</p>
                        </a>
                    </li>
                    <li>
                        <a onclick="Logout()">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <p data-translate="logout">Logout</p>
                        </a>
                    </li>

                </ul>
            </div>
        </div>

        <div class="main-panel">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
                <div class="container-fluid">
                    <select id="language-dropdown" class="form-control"
                        style="width: auto; display: inline-block; margin-right: 15px;">
                        <option value="en" data-translate="optionenglish">English</option>
                        <option value="hi" data-translate="optionhindi">Hindi</option>
                    </select>
                    <div class="navbar-wrapper">
                        <a class="navbar-brand" href="javascript:;" data-translate="dashboard">Add Topic</a>
                    </div>
                    <div class="navbar-toggle">
                        <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
                            <span class="navbar-toggler-bar bar1"></span>
                            <span class="navbar-toggler-bar bar2"></span>
                            <span class="navbar-toggler-bar bar3"></span>
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Page Content -->
            <div class="content" style="min-height: 75vh;">
                <div class="container">
                    <h2 class="my-4" data-translate="add_topic">Add Topic</h2>
                    <form id="topicForm">
                        <div id="changeOrderParent" class="d-flex">
                            <div class="form-group order-1">
                                <label for="topicEnglish" data-translate="topic_english">Topic Name
                                    (English)</label>
                                <input type="text" id="topicEnglish" class="form-control"
                                    placeholder="Enter topic name in English" required>
                            </div>
                            <div class="form-group order-2">
                                <label for="topicHindi" data-translate="topic_hindi">Topic Name (Hindi)</label>
                                <input type="text" id="topicHindi" class="form-control"
                                    placeholder="Enter topic name in Hindi" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" data-translate="add_topic">Add
                            Topic</button>
                    </form>
                    <div id="message" class="mt-3"></div>
                </div>
            </div>

            <footer class="footer footer-black footer-white">
                <div class="container-fluid">
                    <hr>
                    <div class="row">
                        <div class="credits mx-auto">
                            <span class="copyright">
                                ©
                                <script>document.write(new Date().getFullYear())</script>, <span
                                    data-translate="copyright">All rights reserved by Pustakam</span>
                            </span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Core JS Files -->
    <script src="./assets/js/core/jquery.min.js"></script>
    <script src="./assets/js/core/popper.min.js"></script>
    <script src="./assets/js/core/bootstrap.min.js"></script>
    <script>
        function Logout() {
            localStorage.removeItem('loggedadmin')
            location.href = '/login.html'
        }
        let changeOrderParentHandler = () => {
            let changeOrderParent = document.getElementById('changeOrderParent');

            let currLanguage = localStorage.getItem('language') || 'en'

            if (currLanguage === 'hi') {
                changeOrderParent.style.flexDirection = 'column-reverse'
            } else {
                changeOrderParent.style.flexDirection = 'column'
            }
        }
        changeOrderParentHandler()
        let activeListeners = []; // Track active event listeners

        // Language JSON and translation function
        const englishJson = {
            "optionenglish": "English", "optionhindi": "Hindi", "logotxt": "Pustakam", "dashboard": "Dashboard", "authors": "Authors", "topics": "Topics", "checkout_details": "Checkout Details", "add_topic": "Add Topic", "topic_english": "Topic Name (English)", "topic_hindi": "Topic Name (Hindi)", "copyright": "All rights reserved by Pustakam",
            "books": "Books",
            "languages": "Languages",
            "logout": "Logout",
            "placeholder_topic_english": "Enter topic name in English",
            "placeholder_topic_hindi": "Enter topic name in Hindi",

        };
        const hindiJson = {
            "optionenglish": "अंग्रेजी", "optionhindi": "हिंदी", "logotxt": "पुस्तकम", "dashboard": "डैशबोर्ड", "authors": "लेखक", "topics": "श्रेणियाँ", "checkout_details": "विवरण देखें", "add_topic": "श्रेणी जोड़ें", "topic_english": "श्रेणी का नाम (अंग्रेजी)", "topic_hindi": "श्रेणी का नाम (हिंदी)", "copyright": "सभी अधिकार पुस्तकम द्वारा सुरक्षित",
            "books": "पुस्तकें",
            "languages": "भाषाएँ",
            "logout": "लॉग आउट",
            "placeholder_topic_english": "अंग्रेज़ी में श्रेणी का नाम दर्ज करें",
            "placeholder_topic_hindi": "हिंदी में श्रेणी का नाम दर्ज करें",

        };

        const fieldMappings = [
            { sourceFieldId: "topicEnglish", targetFieldId: "topicHindi", sourceLang: "en", targetLang: "hi" },
        ];
        const fieldMappingsHindi = [
            { sourceFieldId: "topicHindi", targetFieldId: "topicEnglish", sourceLang: "hi", targetLang: "en" },
        ];

        function loadLanguage(language) {
            const translations = language === "hi" ? hindiJson : englishJson;
            document.querySelectorAll("[data-translate]").forEach((element) => {
                const key = element.getAttribute("data-translate");
                if (translations[key]) {
                    element.textContent = translations[key];
                }
            });

            // Update placeholders
            const topicEnglishInput = document.getElementById("topicEnglish");
            const topicHindiInput = document.getElementById("topicHindi");

            if (topicEnglishInput && translations["placeholder_topic_english"]) {
                topicEnglishInput.placeholder = translations["placeholder_topic_english"];
            }

            if (topicHindiInput && translations["placeholder_topic_hindi"]) {
                topicHindiInput.placeholder = translations["placeholder_topic_hindi"];
            }
        }

        document.getElementById('language-dropdown').addEventListener('change', function () {
            const selectedLanguage = this.value;
            localStorage.setItem('language', selectedLanguage);
            loadLanguage(selectedLanguage);
            const fieldMappingsData = selectedLanguage === 'en' ? fieldMappings : fieldMappingsHindi;
            languagesChangHandler(fieldMappingsData);
            changeOrderParentHandler()

        });

        document.addEventListener('DOMContentLoaded', () => {
            const language = localStorage.getItem('language') || 'en';
            document.getElementById('language-dropdown').value = language;
            loadLanguage(language);
            const fieldMappingsData = language === 'en' ? fieldMappings : fieldMappingsHindi;
            languagesChangHandler(fieldMappingsData);
        });

        function debounce(func, delay) {
            let debounceTimer;
            return function (...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        const googleTranslateAPIKey = 'AIzaSyBlk5ZotGsdHMkbjPNarkmr9b3FV5n8vDo';

        async function translateText(text, sourceLang, targetLang) {
            const url = `https://translation.googleapis.com/language/translate/v2?key=${googleTranslateAPIKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q: text, source: sourceLang, target: targetLang, format: 'text' }),
                });
                const data = await response.json();
                return data?.data?.translations?.[0]?.translatedText || text;
            } catch (error) {
                console.error('Translation API error:', error);
                return text;
            }
        }

        function languagesChangHandler(languageData) {
            activeListeners.forEach(({ element, handler }) => {
                element.removeEventListener('input', handler);
            });
            activeListeners = [];

            languageData.forEach(({ sourceFieldId, targetFieldId, sourceLang, targetLang }) => {
                const sourceField = document.getElementById(sourceFieldId);
                const targetField = document.getElementById(targetFieldId);

                if (sourceField && targetField) {
                    const handler = debounce(async () => {
                        const translatedText = await translateText(sourceField.value, sourceLang, targetLang);
                        targetField.value = translatedText;
                    }, 500);

                    sourceField.addEventListener('input', handler);
                    activeListeners.push({ element: sourceField, handler });
                }
            });
        }

        document.getElementById('topicForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            // Get the input values
            const topicEnglish = document.getElementById('topicEnglish').value;
            const topicHindi = document.getElementById('topicHindi').value;

            const data = {
                topic_english: topicEnglish,
                topic_hindi: topicHindi,
            };

            const messageDiv = document.getElementById('message');

            try {
                // Fetch all topics to check for duplicates
                const response = await fetch('https://pustakam.pythonanywhere.com/topic/');
                const result = await response.json();

                if (result.status === "success") {
                    const existingTopics = result.data;

                    // Check if topic already exists (either English or Hindi)
                    const isTopicExist = existingTopics.some(topic =>
                        topic.topic_english.toLowerCase() === topicEnglish.toLowerCase() ||
                        topic.topic_hindi.toLowerCase() === topicHindi.toLowerCase()
                    );

                    if (isTopicExist) {
                        // Show error message if topic already exists
                        messageDiv.innerHTML = `<div class="alert alert-danger">Topic already exists!</div>`;
                        setTimeout(() => {
                            messageDiv.innerHTML = '';
                        }, 3000);
                        return; // Prevent form submission
                    }

                    // Proceed with adding the new topic if no duplicates found
                    const addTopicResponse = await fetch('https://pustakam.pythonanywhere.com/topic/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });

                    const addTopicResult = await addTopicResponse.json();

                    if (addTopicResult.status === 'success') {
                        messageDiv.innerHTML = '<div class="alert alert-success">Topic added successfully!</div>';
                        document.getElementById('topicForm').reset();
                        location.href = '/topics.html'
                    } else {
                        messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${addTopicResult.message || 'Failed to add topic'}</div>`;
                    }

                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.message || 'Failed to fetch topics'}</div>`;
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            }
        });

    </script>

</body>

</html>