<script src="./assets/js/apis/auth.js"></script>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/finalLogo.jpeg">
    <link rel="icon" type="image/png" href="./assets/img/finalLogo.jpeg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title data-translate="logotxt">Pustakam</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="./assets/css/paper-dashboard.css?v=2.0.1" rel="stylesheet" />
    <link href="./assets/demo/demo.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">

    <style>
        @media (max-width: 991px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 1040;
                height: 100%;
                background-color: #fff;
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                display: block;
                transform: translateX(0);
            }

            .main-panel {
                padding-left: 0;
            }

            .navbar-toggler {
                display: inline-block;
            }
        }

        .custom-file-input:lang(en)~.custom-file-label::after {
            content: "Browse";

        }

        #viewer {
            width: 100%;
            height: 600px;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px auto;

        }
    </style>

</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-color="white" data-active-color="danger">
            <div class="logo">
                <a href="/" class="simple-text logo-mini">
                    <div class="logo-image-small">
                        <img src="./assets/img/finalLogo.jpeg">
                    </div>
                </a>
                <a href="/" class="simple-text logo-normal" data-translate="logotxt">Pustakam</a>
            </div>
            <div class="sidebar-wrapper">
                <ul class="nav">
                    <li>
                        <a href="/">
                            <i class="nc-icon nc-bank"></i>
                            <p data-translate="dashboard">Dashboard</p>
                        </a>
                    </li>
                    <li>
                        <a href="./topics.html">
                            <i class="fa fa-folder"></i>
                            <p data-translate="topics">Topics</p>
                        </a>
                    </li>
                    <li>
                        <a href="./authers.html">
                            <i class="fa-solid fa-users"></i>
                            <p data-translate="authors">Authors</p>
                        </a>
                    </li>
                    <li><a href="./books.html"><i class="fa fa-book"></i>
                            <p data-translate="books">Books</p>
                        </a></li>
                    <li>
                        <a href="./languages.html">
                            <i class="fa fa-language"></i>
                            <p data-translate="languages">Languages</p>
                        </a>
                    </li>
                    <li>
                        <a onclick="Logout()">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <p data-translate="logout">Logout</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-panel">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
                <div class="container-fluid">
                    <select id="language-dropdown" class="form-control"
                        style="width: auto; display: inline-block; margin-right: 15px;">
                        <option value="en" data-translate="optionenglish">English</option>
                        <option value="hi" data-translate="optionhindi">Hindi</option>
                    </select>
                    <div class="navbar-wrapper">
                        <a class="navbar-brand" href="javascript:;" data-translate="dashboard">Add Author</a>
                    </div>
                    <div class="navbar-toggle">
                        <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
                            <span class="navbar-toggler-bar bar1"></span>
                            <span class="navbar-toggler-bar bar2"></span>
                            <span class="navbar-toggler-bar bar3"></span>
                        </button>
                    </div>
                </div>
            </nav>

            <div class="content">
                <div class="container">
                    <h2 class="my-4" data-translate="add_book">Add Book</h2>
                    <form id="bookForm">
                        <!-- Book Topic -->
                        <div class="form-group">
                            <label for="topicSelect" data-translate="topic_select">Book Topic</label>
                            <select id="topicSelect" class="form-control custom-select" multiple required></select>
                            <button type="button" class="btn btn-primary"
                                onclick="addTopicAndAuther(event,'topic')">+</button>
                        </div>

                        <!-- Author Name -->
                        <div class="form-group">
                            <label for="authorSelect" data-translate="author_select">Author Name</label>
                            <select id="authorSelect" class="form-control custom-select" multiple required></select>
                            <button type="button" class="btn btn-primary"
                                onclick="addTopicAndAuther(event,'auther')">+</button>
                        </div>

                        <!-- Book Language -->
                        <div class="form-group">
                            <label for="languageSelect" data-translate="book_language">Book Language</label>
                            <select id="languageSelect" class="form-control custom-select" multiple required></select>
                        </div>

                        <div class="d-flex changeOrderParent">
                            <!-- Book Name (English) -->
                            <div class=" form-group">
                                <label for="bookNameEnglish" data-translate="book_name_english">Book Name (in
                                    English)</label>
                                <input type="text" id="bookNameEnglish" class="form-control"
                                    placeholder="Enter book name in English"
                                    data-translate="placeholder_book_name_english" required>
                            </div>

                            <!-- Book Name (Hindi) -->
                            <div class="form-group">
                                <label for="bookNameHindi" data-translate="book_name_hindi"
                                    data-translate="placeholder_book_name_hindi">Book Name (in Hindi)</label>
                                <input type="text" id="bookNameHindi" class="form-control"
                                    placeholder="Enter book name in Hindi" data-translate="placeholder_book_name_hindi"
                                    required>
                            </div>
                        </div>

                        <!-- Book Front Image -->
                        <div class="form-group">
                            <label for="bookFrontImage" data-translate="book_thumbnail">Book Front Image</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="bookFrontImage" accept="image/*">
                                <label class="custom-file-label" for="bookFrontImage"
                                    data-translate="customFileText">Choose file</label>
                            </div>
                        </div>
                        <img id='bookCover' src="" alt="">

                        <!-- Book File -->
                        <div class="form-group">
                            <label for="bookFile" data-translate="book_file">Book File (PDF or EPUB)</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="bookFile" accept=".pdf,.epub" required>
                                <label class="custom-file-label" for="bookFile" data-translate="customFileText">Choose
                                    file</label>
                            </div>
                        </div>


                        <div class="d-flex changeOrderParent">
                            <!-- Book Details (English) -->
                            <div class="form-group">
                                <label for="bookDetailsEnglish" data-translate="book_details_english">Book Details (in
                                    English)</label>
                                <textarea data-translate="placeholder_book_details_english" id="bookDetailsEnglish"
                                    class="form-control" placeholder="Enter book details in English"
                                    required></textarea>
                            </div>

                            <!-- Book Details (Hindi) -->
                            <div class="form-group">
                                <label for="bookDetailsHindi" data-translate="book_details_hindi">Book Details (in
                                    Hindi)</label>
                                <textarea data-translate="placeholder_book_details_hindi" id="bookDetailsHindi"
                                    class="form-control" placeholder="Enter book details in Hindi" required></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="bookKeywords" data-translate="book_keywords">Book Keywords</label>
                            <textarea data-translate="placeholder_book_keywords" id="bookKeywords" class="form-control"
                                placeholder="Enter book Keywords"></textarea>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="bookFreeOrNot"></input>
                            <label for="bookKeywords" data-translate="book_free">Free Book</label>
                        </div>


                        <div id="bookPriceInputs">
                            <!-- Book Price -->
                            <div class="form-group">
                                <label for="bookPrice" data-translate="book_price">Book Price</label>
                                <input data-translate="placeholder_book_price" type="number" id="bookPrice"
                                    class="form-control" placeholder="Enter book price">
                            </div>

                            <!-- Discounted Price -->
                            <div class="form-group">
                                <label for="bookPriceDiscount" data-translate="book_price_discount">Book Discounted
                                    Price</label>
                                <div class="input-group">
                                    <input data-translate="placeholder_discounted_price" type="number"
                                        id="bookPriceDiscount" class="form-control"
                                        placeholder="Enter discounted price">
                                    <div class="input-group-append">
                                        <div class="input-group-text">
                                            <input type="checkbox" id="useOriginalPrice">
                                            <label for="useOriginalPrice" class="ml-2"
                                                data-translate="use_org_price">Use
                                                original price</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Free Demo Pages Percentage -->
                            <div class="form-group">
                                <label for="bookDemoPercent" data-translate="book_free_demo">Free Demo Pages
                                    Percentage</label>
                                <input data-translate="placeholder_free_demo" type="number" id="bookDemoPercent"
                                    class="form-control" placeholder="Enter percentage (0-100)" min="0" max="100">
                            </div>
                        </div>
                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary" data-translate="add_book">Add Book</button>
                    </form>

                    <div id="message" class="mt-3"></div>
                </div>
            </div>

            <footer class="footer footer-black footer-white">
                <div class="container-fluid">
                    <hr>
                    <div class="row">
                        <div class="credits mx-auto">
                            <span class="copyright">
                                ©
                                <script>document.write(new Date().getFullYear())</script>, <span
                                    data-translate="copyright">All rights reserved by Pustakam</span>
                            </span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <div class="modal fade" id="addTopicModal" tabindex="-1" role="dialog" aria-labelledby="addTopicModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTopicModalLabel">Add Topic</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addTopicForm">
                        <div class="changeOrderParent d-flex">

                            <div class="form-group">
                                <label for="addTopicEnglish" data-translate="topic_english">Topic Name
                                    (English)</label>
                                <input type="text" id="addTopicEnglish" class="form-control"
                                    placeholder="Enter topic name in English" required>
                            </div>
                            <div class="form-group">
                                <label for="addTopicHindi" data-translate="topic_hindi">Topic Name
                                    (Hindi)</label>
                                <input type="text" id="addTopicHindi" class="form-control"
                                    placeholder="Enter topic name in Hindi" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Topic</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addAuthorModal" tabindex="-1" role="dialog" aria-labelledby="addAuthorModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAuthorModalLabel">Add Author</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addAuthorForm">
                        <div class="changeOrderParent d-flex">


                            <div class="form-group">
                                <label for="addAuthorEnglish" data-translate="author_english">Author Name
                                    (English)</label>
                                <input type="text" id="addAuthorEnglish" class="form-control"
                                    placeholder="Enter author name in English" required>
                            </div>
                            <div class="form-group">
                                <label for="addAuthorHindi" data-translate="author_hindi">Author Name (Hindi)</label>
                                <input type="text" id="addAuthorHindi" class="form-control"
                                    placeholder="Enter author name in Hindi" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="authorTopicSelect" data-translate="topic_select">Topic</label>
                            <select id="authorTopicSelect" class="form-control custom-select">
                                <!-- Topics will be dynamically populated -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Author</button>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Core JS Files -->
    <script src="./assets/js/core/jquery.min.js"></script>
    <script src="./assets/js/core/popper.min.js"></script>
    <script src="./assets/js/core/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>


    <script>
        let bookFrontImageFromPdf = null
        let initSelect2 = (placeH) => {
            $('#authorSelect, #topicSelect, #languageSelect').select2({
                placeholder: placeH,
                allowClear: true,
                width: '100%',
            });
        }


        let selectMenuPlaceHolder = {
            en: "Select an option",
            hi: "विकल्प चुनें",
        }
        function Logout() {
            localStorage.removeItem('loggedadmin')
            location.href = '/login.html'
        }
        // Update field order based on selected language
        function changeOrderParentHandler() {
            const changeOrderParents = document.querySelectorAll('.changeOrderParent'); // Select all elements with the class
            const currLanguage = localStorage.getItem('language') || 'en';

            let placeH = currLanguage === 'en' ? selectMenuPlaceHolder.en : selectMenuPlaceHolder.hi
            initSelect2(placeH)

            // Loop through each element and set its flexDirection
            changeOrderParents.forEach(changeOrderParent => {
                changeOrderParent.style.flexDirection = currLanguage === 'hi' ? 'column-reverse' : 'column';
            });
        }

        changeOrderParentHandler()
        // Translation mappings
        const fieldMappingsEnToHi = [
            { sourceFieldId: "bookNameEnglish", targetFieldId: "bookNameHindi", sourceLang: "en", targetLang: "hi" },
            { sourceFieldId: "bookDetailsEnglish", targetFieldId: "bookDetailsHindi", sourceLang: "en", targetLang: "hi" },
            { sourceFieldId: "addAuthorEnglish", targetFieldId: "addAuthorHindi", sourceLang: "en", targetLang: "hi" },
            { sourceFieldId: "addTopicEnglish", targetFieldId: "addTopicHindi", sourceLang: "en", targetLang: "hi" },
        ];

        const fieldMappingsHiToEn = [
            { sourceFieldId: "bookNameHindi", targetFieldId: "bookNameEnglish", sourceLang: "hi", targetLang: "en" },
            { sourceFieldId: "bookDetailsHindi", targetFieldId: "bookDetailsEnglish", sourceLang: "hi", targetLang: "en" },
            { sourceFieldId: "addAuthorHindi", targetFieldId: "addAuthorEnglish", sourceLang: "hi", targetLang: "en" },
            { sourceFieldId: "addTopicHindi", targetFieldId: "addTopicEnglish", sourceLang: "hi", targetLang: "en" },
        ];

        const translations = {
            en: {
                logotxt: "Pustakam",
                dashboard: "Dashboard",
                authors: "Authors",
                topics: "Topics",
                books: "Books",
                languages: "Languages",
                add_book: "Add Book",
                author_select: "Select Authors",
                topic_select: "Select Topics",
                book_name_english: "Book Name (English)",
                book_name_hindi: "Book Name (Hindi)",
                book_details_english: "Book Details (English)",
                book_details_hindi: "Book Details (Hindi)",
                book_language: "Book Language",
                book_price: "Book Price",
                book_price_discount: "Discounted Price",
                book_free_demo: "Free Demo Pages Percentage",
                book_thumbnail: "Book Front Image",
                book_file: "Book File (PDF or EPUB)",
                add_button: "Add Book",
                optionenglish: "English",
                optionhindi: "Hindi",
                use_org_price: "Use Original Price",
                logout: "Logout",
                placeholder_book_name_english: "Enter book name in English",
                placeholder_book_name_hindi: "Enter book name in Hindi",
                placeholder_book_details_english: "Enter book details in English",
                placeholder_book_details_hindi: "Enter book details in Hindi",
                placeholder_book_price: "Enter book price",
                placeholder_discounted_price: "Enter discounted price",
                placeholder_free_demo: "Enter percentage (0-100)",
                customFileText: "Choose file"
            },
            hi: {
                logotxt: "पुस्तकम",
                dashboard: "डैशबोर्ड",
                authors: "लेखक",
                topics: "श्रेणियाँ",
                books: "पुस्तकें",
                languages: "भाषाएँ",
                add_book: "पुस्तक जोड़ें",
                author_select: "लेखकों का चयन करें",
                topic_select: "श्रेणियाँ चुनें",
                book_name_english: "पुस्तक का नाम (अंग्रेज़ी)",
                book_name_hindi: "पुस्तक का नाम (हिंदी)",
                book_details_english: "पुस्तक का विवरण (अंग्रेज़ी)",
                book_details_hindi: "पुस्तक का विवरण (हिंदी)",
                book_language: "पुस्तक भाषा",
                book_price: "पुस्तक मूल्य",
                book_price_discount: "छूट मूल्य",
                book_free_demo: "नि: शुल्क डेमो पृष्ठ प्रतिशत",
                book_thumbnail: "पुस्तक का अग्रभाग छवि",
                book_file: "पुस्तक फ़ाइल (पीडीएफ़ या ईपब)",
                add_button: "पुस्तक जोड़ें",
                optionenglish: "अंग्रेजी",
                optionhindi: "हिंदी",
                use_org_price: "मूल मूल्य का उपयोग करें",
                logout: "लॉग आउट",
                placeholder_book_name_english: "अंग्रेज़ी में पुस्तक का नाम दर्ज करें",
                placeholder_book_name_hindi: "हिंदी में पुस्तक का नाम दर्ज करें",
                placeholder_book_details_english: "अंग्रेज़ी में पुस्तक विवरण दर्ज करें",
                placeholder_book_details_hindi: "हिंदी में पुस्तक विवरण दर्ज करें",
                placeholder_book_price: "पुस्तक मूल्य दर्ज करें",
                placeholder_discounted_price: "छूट मूल्य दर्ज करें",
                placeholder_free_demo: "प्रतिशत दर्ज करें (0-100)",
                customFileText: "फाइलें चुनें"
            },
        };


        function loadLanguage(language) {
            $("[data-translate]").each(function () {
                const key = $(this).data("translate");
                const translation = translations[language]?.[key];
                if (translation) {
                    if ($(this).is("input") || $(this).is("textarea")) {
                        $(this).attr("placeholder", translation); // Update placeholder
                    } else {
                        $(this).text(translation); // Update text
                    }
                }
            });
            let newValue = language == 'en' ? 'Browse' : 'ब्राउज़ करें'
            var add = '<style>.custom-file-input:lang(en)~.custom-file-label::after{content:"' + newValue + '"!important;}</style>';
            $('body').append(add);
        }

        // Translate text using Google Translate API
        async function translateText(text, sourceLang, targetLang) {
            const apiKey = 'AIzaSyBlk5ZotGsdHMkbjPNarkmr9b3FV5n8vDo';
            const url = `https://translation.googleapis.com/language/translate/v2?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ q: text, source: sourceLang, target: targetLang, format: "text" }),
                });

                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const data = await response.json();
                return data?.data?.translations?.[0]?.translatedText || text;
            } catch (error) {
                console.error("Translation API error:", error);
                return text;
            }
        }

        // Debounce function to limit API calls
        function debounce(func, delay) {
            let debounceTimer;
            return function (...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        bookFreeOrNot.addEventListener('change', function (e) {
            let is = e.target.checked
            if (is) {
                document.getElementById('bookPriceInputs').style.display = 'none'
                bookPrice.vlaue = 0
                bookPriceDiscount.vlaue = 0
                bookDemoPercent.vlaue = 0
            } else {
                document.getElementById('bookPriceInputs').style.display = 'block'

            }

        })

        // Dynamic field event handling
        let activeListeners = [];

        function updateFieldTranslationHandlers(fieldMappings) {
            activeListeners.forEach(({ element, handler }) => {
                element.removeEventListener("input", handler);
            });

            activeListeners = [];

            fieldMappings.forEach(({ sourceFieldId, targetFieldId, sourceLang, targetLang }) => {
                const sourceField = document.getElementById(sourceFieldId);
                const targetField = document.getElementById(targetFieldId);

                if (sourceField && targetField) {
                    const handler = debounce(async () => {
                        const translatedText = await translateText(sourceField.value, sourceLang, targetLang);
                        targetField.value = translatedText;
                    }, 500);

                    sourceField.addEventListener("input", handler);
                    activeListeners.push({ element: sourceField, handler });
                }
            });
        }

        // Load topics dynamically
        async function populateSelectOptions(url, selectElement, keys) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                const options = data.data
                    .map(item => {
                        const displayText = Array.isArray(keys)
                            ? keys.map(key => item[key]).filter(Boolean).join(" (") + ")"
                            : item[keys];
                        return `<option value="${item.id}">${displayText}</option>`;
                    })
                    .join("");
                $(selectElement).html(options);
            } catch (error) {
                console.error(`Error populating ${selectElement}:`, error);
            }
        }

        // Initialize on document ready
        $(document).ready(() => {
            const savedLanguage = localStorage.getItem("language") || "en";
            let placeH = savedLanguage === 'en' ? selectMenuPlaceHolder.en : selectMenuPlaceHolder.hi
            initSelect2(placeH)

            $("#language-dropdown").val(savedLanguage);

            loadLanguage(savedLanguage);
            updateFieldTranslationHandlers(savedLanguage === "en" ? fieldMappingsEnToHi : fieldMappingsHiToEn);

            populateSelectOptions("https://pustakam.pythonanywhere.com/topic/", "#topicSelect", ["topic_english", "topic_hindi"]);
            populateSelectOptions("https://pustakam.pythonanywhere.com/author/", "#authorSelect", ["author_english", "author_hindi"]);
            populateSelectOptions("https://pustakam.pythonanywhere.com/languages/", "#languageSelect", "languages");

            $("#language-dropdown").on("change", function () {
                const selectedLanguage = $(this).val();
                localStorage.setItem("language", selectedLanguage);
                loadLanguage(selectedLanguage);

                const newFieldMappings = selectedLanguage === "en" ? fieldMappingsEnToHi : fieldMappingsHiToEn;
                updateFieldTranslationHandlers(newFieldMappings);
                changeOrderParentHandler();
                let newValue = selectedLanguage == 'en' ? 'Browse' : 'ब्राउज़ करें'
                var add = '<style>.custom-file-input:lang(en)~.custom-file-label::after{content:"' + newValue + '"!important;}</style>';
                $('body').append(add);
            });
            // Handle book front image file selection
            $("#bookFrontImage").on("change", function () {
                let selectedLanguage = localStorage.getItem('language')
                let defaultText = selectedLanguage === 'en' ? 'Choose file' : 'फाइलें चुनें'
                const fileName = $(this).prop("files")[0]?.name || defaultText;
                $(this).next(".custom-file-label").text(fileName);
            });

            // Handle book file (EPUB/PDF) selection
            $("#bookFile").on("change", function () {
                let selectedLanguage = localStorage.getItem('language')
                let defaultText = selectedLanguage === 'en' ? 'Choose file' : 'फाइलें चुनें'
                const fileName = $(this).prop("files")[0]?.name || defaultText;
                $(this).next(".custom-file-label").text(fileName);
            });
        });



        // Submit New Book Functionality
        $("#bookForm").on("submit", async function (event) {
            event.preventDefault();

            const formData = new FormData(this);

            // Ensure multi-select fields are handled correctly: Convert selected options to integers
            const selectedAuthors = $("#authorSelect").val().map(val => parseInt(val, 10));
            const selectedTopics = $("#topicSelect").val().map(val => parseInt(val, 10));
            const selectedLanguages = $("#languageSelect").val().map(val => parseInt(val, 10));
            let bookKeywords = $("#bookKeywords").val()?.split(',')



            // Handle multi-select data by setting them correctly in the formData

            bookKeywords.map((x) => {
                formData.append("book_keywords", x);
            })
            selectedTopics.map((x) => {
                formData.append("topic_data", x);
            })
            selectedAuthors.map((x) => {
                formData.append("author_data", x);
            })
            selectedLanguages.map((x) => {
                formData.append("language_data", x);
            })


            // Handle other fields
            let bookDemoPercent = $("#bookDemoPercent").val() || 0
            formData.set("book_free_demo", bookDemoPercent);

            formData.set("book_name_english", $("#bookNameEnglish").val());
            formData.set("book_name_hindi", $("#bookNameHindi").val());
            formData.set("book_details_english", $("#bookDetailsEnglish").val());
            formData.set("book_details_hindi", $("#bookDetailsHindi").val());
            let bookPrice = $("#bookPrice").val() || 0
            let bookPriceDiscount = $("#bookPriceDiscount").val() || 0
            formData.set("book_price", bookPrice);
            formData.set("book_price_discount", bookPriceDiscount);

            // Handle book files (image and PDF/EPUB)
            const bookFrontImage = $("#bookFrontImage")[0].files[0] || bookFrontImageFromPdf;
            const bookFile = $("#bookFile")[0].files[0];

            let imageName = Math.random() + '-' + '.png'
            formData.set("book_front_image", bookFrontImage, imageName);

            if (bookFile) {
                formData.set("book_file", bookFile);
            }

            try {
                const response = await fetch("https://pustakam.pythonanywhere.com/books/", {
                    method: "POST",
                    body: formData,
                });

                const result = await response.json();

                const message = result.status === 'success'
                    ? `<div class="alert alert-success">Book added successfully!</div>`
                    : `<div class="alert alert-danger">Error: ${result.message || "Failed to add book"}</div>`;

                $("#message").html(message);

                if (result.status === 'success') {
                    $("#bookForm")[0].reset(); // Reset the form on success
                    // Optionally, redirect to another page
                    // location.href = '/books.html';
                }

                setTimeout(() => $("#message").html(""), 3000); // Clear the message after 3 seconds
            } catch (error) {
                console.error("Error submitting form:", error);
                $("#message").html('<div class="alert alert-danger">An error occurred. Please try again.</div>');
                setTimeout(() => $("#message").html(""), 3000);
            }
        });


        function addTopicAndAuther(event, type) {
            event.preventDefault();

            if (type === 'topic') {
                // Show the Add Topic modal
                $('#addTopicModal').modal('show');
            } else if (type === 'auther') {
                // Show the Add Author modal
                fetchTopics();
                $('#addAuthorModal').modal('show');
            }
        }

        // Handling Add Topic form submission
        $("#addTopicForm").on("submit", async function (event) {
            event.preventDefault();
            const topicEnglish = $("#addTopicEnglish").val();
            const topicHindi = $("#addTopicHindi").val();

            try {
                const response = await fetch('https://pustakam.pythonanywhere.com/topic/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic_english: topicEnglish, topic_hindi: topicHindi })
                });

                if (response.ok) {
                    $('#addTopicModal').modal('hide');
                    // Display success message
                } else {
                    // Handle failure
                }
            } catch (error) {
                console.error('Error adding topic:', error);
            }
        });

        // Handling Add Author form submission
        $("#addAuthorForm").on("submit", async function (event) {
            event.preventDefault();
            const authorEnglish = $("#addAuthorEnglish").val();
            const authorHindi = $("#addAuthorHindi").val();
            const topicId = $("#authorTopicSelect").val();

            try {
                const response = await fetch('https://pustakam.pythonanywhere.com/author/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author_english: authorEnglish, author_hindi: authorHindi, topic_data: topicId })
                });

                if (response.ok) {
                    $('#addAuthorModal').modal('hide');
                    // Display success message
                } else {
                    // Handle failure
                }
            } catch (error) {
                console.error('Error adding author:', error);
            }
        });

        // Fetch topics and populate the "Add Author" modal
        async function fetchTopics() {
            try {
                const response = await fetch('https://pustakam.pythonanywhere.com/topic/');
                const result = await response.json();
                const topicSelect = $('#authorTopicSelect');

                if (result.status === 'success') {
                    const topics = result.data;
                    topicSelect.empty(); // Clear existing options
                    topics.forEach(topic => {
                        topicSelect.append(new Option(topic.topic_english, topic.id));
                    });
                } else {
                    console.error('Failed to fetch topics:', result.message);
                }
            } catch (error) {
                console.error('Error fetching topics:', error);
            }
        }

        // Function to validate the input
        function validateInput(e) {
            let val = e.target.value;

            // Check if the input contains any alphabetic characters, special characters, or negative signs
            const regex = /[^0-9.]/g;  // Allow only numbers and the decimal point

            // Remove any invalid characters (non-numeric or special characters)
            val = val.replace(regex, '');

            // Prevent negative numbers
            if (val.startsWith('-')) {
                val = '';  // Clear the value or set to zero, depending on your preference
            }

            // Ensure only one decimal point is allowed
            if ((val.match(/\./g) || []).length > 1) {
                val = val.replace(/\.(?=.*\.)/, ''); // Remove additional decimal points
            }

            // Update the input field with the validated value
            e.target.value = val;
        }

        // Add event listeners with validation
        bookPrice.addEventListener('input', validateInput);
        bookPriceDiscount.addEventListener('input', validateInput);
        bookDemoPercent.addEventListener('input', validateInput);



        function renderPdfThumbnail(file) {
            const fileReader = new FileReader();

            fileReader.onload = function (event) {
                const fileData = new Uint8Array(event.target.result);

                // Check if the file is a PDF or EPUB
                if (file.type === 'application/pdf') {
                    // Handle PDF rendering
                    renderPdfThumbnailFromPdf(fileData);

                } else if (file.type === 'application/epub+zip') {

                    // Handle EPUB rendering

                    renderPdfThumbnailFromEpub(file);
                }
            };

            fileReader.readAsArrayBuffer(file);
        }

        // Render PDF's first page as an image
        function renderPdfThumbnailFromPdf(pdfData) {
            pdfjsLib.getDocument(pdfData).promise.then(function (pdf) {
                pdf.getPage(1).then(function (page) {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale: scale });

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise.then(function () {
                        const imageData = canvas.toDataURL('image/png');  // Convert to PNG
                        const blob = dataURLToBlob(imageData);
                        bookFrontImageFromPdf = blob;  // Store for form submission
                        console.log(bookFrontImageFromPdf);

                    });
                });
            });
        }

        // Function to render the first page of the EPUB as an image (PNG/JPG)
        function renderPdfThumbnailFromEpub(epubData) {
            const reader = new FileReader();

            reader.onload = function () {
                const book = ePub(reader.result);

                book.ready.then((b) => {
                    // Fetch and display the cover image
                    book.coverUrl().then((url) => {
                        let bookCoverSrc = url;
                        console.log('Cover image URL:', bookCoverSrc);

                        // Set the cover image to the img tag
                        document.getElementById('bookCover').src = bookCoverSrc;
                        convertImageToBlob(bookCoverSrc).then((blob) => {
                            bookFrontImageFromPdf = blob
                            console.log(blob);

                        });
                    }).catch((error) => {
                        console.error('Error retrieving cover image:', error);
                    });
                }).catch((error) => {
                    console.error('Error loading EPUB:', error);
                });
            };

            // Read the EPUB file as an ArrayBuffer
            reader.readAsArrayBuffer(epubData);

        }
        function dataURLToBlob(dataURL) {
            const [header, base64] = dataURL.split(',');
            const mimeType = header.match(/:(.*?);/)[1];
            const binary = atob(base64);
            const length = binary.length;
            const arrayBuffer = new ArrayBuffer(length);
            const view = new Uint8Array(arrayBuffer);

            for (let i = 0; i < length; i++) {
                view[i] = binary.charCodeAt(i);
            }

            return new Blob([arrayBuffer], { type: mimeType });
        }
        // Function to convert image to PNG or JPG format using a canvas
        function convertImageToBlob(imageSrc) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function () {
                    // Create a canvas and draw the image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // Convert the canvas content to a Blob (PNG or JPG)
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/png'); // Change to 'image/jpeg' for JPG format
                };

                img.onerror = function () {
                    reject('Failed to load image');
                };

                img.src = imageSrc; // Set the image source to the cover URL
            });
        }

        bookFile.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                if (!bookFrontImage.files.length) { // If no thumbnail is selected
                    renderPdfThumbnail(file);
                }
            }
        });

    </script>


</body>

</html>