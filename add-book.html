<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/logo-small.png">
    <link rel="icon" type="image/png" href="./assets/img/logo-small.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title data-translate="logotxt">Pustakam</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="./assets/css/paper-dashboard.css?v=2.0.1" rel="stylesheet" />
    <link href="./assets/demo/demo.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">

    <style>
        @media (max-width: 991px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 1040;
                height: 100%;
                background-color: #fff;
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                display: block;
                transform: translateX(0);
            }

            .main-panel {
                padding-left: 0;
            }

            .navbar-toggler {
                display: inline-block;
            }
        }
    </style>

</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-color="white" data-active-color="danger">
            <div class="logo">
                <a href="/" class="simple-text logo-mini">
                    <div class="logo-image-small">
                        <img src="./assets/img/logo-small.png">
                    </div>
                </a>
                <a href="/" class="simple-text logo-normal" data-translate="logotxt">Pustakam</a>
            </div>
            <div class="sidebar-wrapper">
                <ul class="nav">
                    <li>
                        <a href="/">
                            <i class="nc-icon nc-bank"></i>
                            <p data-translate="dashboard">Dashboard</p>
                        </a>
                    </li>
                    <li>
                        <a href="./authers.html">
                            <i class="fa-solid fa-users"></i>
                            <p data-translate="authors">Authors</p>
                        </a>
                    </li>
                    <li>
                        <a href="./categories.html">
                            <i class="fa fa-folder"></i>
                            <p data-translate="categories">Categories</p>
                        </a>
                    </li>
                    <li><a href="./books.html"><i class="fa fa-book"></i>
                            <p data-translate="books">Books</p>
                        </a></li>
                    <li>
                        <a href="./languages.html">
                            <i class="fa fa-language"></i>
                            <p data-translate="languages">Languages</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-panel">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
                <div class="container-fluid">
                    <select id="language-dropdown" class="form-control"
                        style="width: auto; display: inline-block; margin-right: 15px;">
                        <option value="en" data-translate="optionenglish">English</option>
                        <option value="hi" data-translate="optionhindi">Hindi</option>
                    </select>
                    <div class="navbar-wrapper">
                        <a class="navbar-brand" href="javascript:;" data-translate="dashboard">Add Author</a>
                    </div>
                    <div class="navbar-toggle">
                        <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
                            <span class="navbar-toggler-bar bar1"></span>
                            <span class="navbar-toggler-bar bar2"></span>
                            <span class="navbar-toggler-bar bar3"></span>
                        </button>
                    </div>
                </div>
            </nav>

            <div class="content">
                <div class="container">
                    <h2 class="my-4" data-translate="add_book">Add Book</h2>
                    <form id="bookForm">
                        <!-- Book Category -->
                        <div class="form-group">
                            <label for="categorySelect" data-translate="category_select">Book Category</label>
                            <select id="categorySelect" class="form-control custom-select" multiple required></select>
                            <button type="button" class="btn btn-primary"
                                onclick="addCategoryAndAuther(event,'category')">+</button>
                        </div>

                        <!-- Author Name -->
                        <div class="form-group">
                            <label for="authorSelect" data-translate="author_select">Author Name</label>
                            <select id="authorSelect" class="form-control custom-select" multiple required></select>
                            <button type="button" class="btn btn-primary"
                                onclick="addCategoryAndAuther(event,'auther')">+</button>
                        </div>

                        <!-- Book Language -->
                        <div class="form-group">
                            <label for="languageSelect" data-translate="book_language">Book Language</label>
                            <select id="languageSelect" class="form-control custom-select" multiple required></select>
                        </div>

                        <!-- Book Name (English) -->
                        <div class="form-group">
                            <label for="bookNameEnglish" data-translate="book_name_english">Book Name (in
                                English)</label>
                            <input type="text" id="bookNameEnglish" class="form-control"
                                placeholder="Enter book name in English" required>
                        </div>

                        <!-- Book Name (Hindi) -->
                        <div class="form-group">
                            <label for="bookNameHindi" data-translate="book_name_hindi">Book Name (in Hindi)</label>
                            <input type="text" id="bookNameHindi" class="form-control"
                                placeholder="Enter book name in Hindi" required>
                        </div>

                        <!-- Book Front Image -->
                        <div class="form-group">
                            <label for="bookFrontImage" data-translate="book_thumbnail">Book Front Image</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="bookFrontImage" accept="image/*"
                                    required>
                                <label class="custom-file-label" for="bookFrontImage">Choose file</label>
                            </div>
                        </div>

                        <!-- Book File -->
                        <div class="form-group">
                            <label for="bookFile" data-translate="book_file">Book File (PDF or EPUB)</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="bookFile" accept=".pdf,.epub" required>
                                <label class="custom-file-label" for="bookFile">Choose file</label>
                            </div>
                        </div>

                        <!-- Book Details (English) -->
                        <div class="form-group">
                            <label for="bookDetailsEnglish" data-translate="book_details_english">Book Details (in
                                English)</label>
                            <textarea id="bookDetailsEnglish" class="form-control"
                                placeholder="Enter book details in English" required></textarea>
                        </div>

                        <!-- Book Details (Hindi) -->
                        <div class="form-group">
                            <label for="bookDetailsHindi" data-translate="book_details_hindi">Book Details (in
                                Hindi)</label>
                            <textarea id="bookDetailsHindi" class="form-control"
                                placeholder="Enter book details in Hindi" required></textarea>
                        </div>

                        <!-- Book Price -->
                        <div class="form-group">
                            <label for="bookPrice" data-translate="book_price">Book Price</label>
                            <input type="number" id="bookPrice" class="form-control" placeholder="Enter book price"
                                required>
                        </div>

                        <!-- Discounted Price -->
                        <div class="form-group">
                            <label for="bookPriceDiscount" data-translate="book_price_discount">Book Discounted
                                Price</label>
                            <div class="input-group">
                                <input type="number" id="bookPriceDiscount" class="form-control"
                                    placeholder="Enter discounted price" required>
                                <div class="input-group-append">
                                    <div class="input-group-text">
                                        <input type="checkbox" id="useOriginalPrice">
                                        <label for="useOriginalPrice" class="ml-2">Use original price</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Free Demo Pages Percentage -->
                        <div class="form-group">
                            <label for="bookDemoPercent" data-translate="book_free_demo">Free Demo Pages
                                Percentage</label>
                            <input type="number" id="bookDemoPercent" class="form-control"
                                placeholder="Enter percentage (0-100)" min="0" max="100" required>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary" data-translate="add_book">Add Book</button>
                    </form>

                    <div id="message" class="mt-3"></div>
                </div>
            </div>

            <footer class="footer footer-black footer-white">
                <div class="container-fluid">
                    <hr>
                    <div class="row">
                        <div class="credits mx-auto">
                            <span class="copyright">
                                ©
                                <script>document.write(new Date().getFullYear())</script>, <span
                                    data-translate="copyright">All rights reserved by Pustakam</span>
                            </span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Add Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm">
                        <div class="form-group">
                            <label for="addCategoryEnglish" data-translate="category_english">Category Name
                                (English)</label>
                            <input type="text" id="addCategoryEnglish" class="form-control"
                                placeholder="Enter category name in English" required>
                        </div>
                        <div class="form-group">
                            <label for="addCategoryHindi" data-translate="category_hindi">Category Name (Hindi)</label>
                            <input type="text" id="addCategoryHindi" class="form-control"
                                placeholder="Enter category name in Hindi" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Category</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addAuthorModal" tabindex="-1" role="dialog" aria-labelledby="addAuthorModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAuthorModalLabel">Add Author</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addAuthorForm">
                        <div class="form-group">
                            <label for="addAuthorEnglish" data-translate="author_english">Author Name (English)</label>
                            <input type="text" id="addAuthorEnglish" class="form-control"
                                placeholder="Enter author name in English" required>
                        </div>
                        <div class="form-group">
                            <label for="addAuthorHindi" data-translate="author_hindi">Author Name (Hindi)</label>
                            <input type="text" id="addAuthorHindi" class="form-control"
                                placeholder="Enter author name in Hindi" required>
                        </div>
                        <div class="form-group">
                            <label for="authorCategorySelect" data-translate="category_select">Category</label>
                            <select id="authorCategorySelect" class="form-control custom-select" required>
                                <!-- Categories will be dynamically populated -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Author</button>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Core JS Files -->
    <script src="./assets/js/core/jquery.min.js"></script>
    <script src="./assets/js/core/popper.min.js"></script>
    <script src="./assets/js/core/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            const translations = {
                en: {
                    logotxt: "Pustakam",
                    dashboard: "Dashboard",
                    authors: "Authors",
                    categories: "Categories",
                    add_book: "Add Book",
                    author_select: "Select Authors",
                    category_select: "Select Categories",
                    book_name_english: "Book Name (English)",
                    book_name_hindi: "Book Name (Hindi)",
                    book_details_english: "Book Details (English)",
                    book_details_hindi: "Book Details (Hindi)",
                    book_language: "Book Language",
                    book_price: "Book Price",
                    book_price_discount: "Discounted Price",
                    book_free_demo: "Free Demo Pages Percentage",
                    book_thumbnail: "Book Front Image",
                    book_file: "Book File (PDF or EPUB)",
                    add_button: "Add Book",
                },
                hi: {
                    logotxt: "पुस्तकम",
                    dashboard: "डैशबोर्ड",
                    authors: "लेखक",
                    categories: "श्रेणियाँ",
                    add_book: "पुस्तक जोड़ें",
                    author_select: "लेखकों का चयन करें",
                    category_select: "श्रेणियाँ चुनें",
                    book_name_english: "पुस्तक का नाम (अंग्रेज़ी)",
                    book_name_hindi: "पुस्तक का नाम (हिंदी)",
                    book_details_english: "पुस्तक का विवरण (अंग्रेज़ी)",
                    book_details_hindi: "पुस्तक का विवरण (हिंदी)",
                    book_language: "पुस्तक भाषा",
                    book_price: "पुस्तक मूल्य",
                    book_price_discount: "छूट मूल्य",
                    book_free_demo: "नि: शुल्क डेमो पृष्ठ प्रतिशत",
                    book_thumbnail: "पुस्तक का अग्रभाग छवि",
                    book_file: "पुस्तक फ़ाइल (पीडीएफ़ या ईपब)",
                    add_button: "पुस्तक जोड़ें",
                },
            };

            // Load translations
            function loadLanguage(language) {
                $("[data-translate]").each(function () {
                    const key = $(this).data("translate");
                    const translation = translations[language][key];
                    if (translation) {
                        $(this).text(translation);
                    }
                });
            }

            // Change language event
            $("#language-dropdown").on("change", function () {
                const selectedLanguage = $(this).val();
                localStorage.setItem("language", selectedLanguage); // Save language preference
                loadLanguage(selectedLanguage);
            });

            // Load saved language on page load
            const savedLanguage = localStorage.getItem("language") || "en";
            $("#language-dropdown").val(savedLanguage);
            loadLanguage(savedLanguage);
        });

        $(document).ready(function () {
            // Initialize select2 for dropdowns
            $('#authorSelect, #categorySelect, #languageSelect').select2({
                placeholder: "Select options",
                allowClear: true,
                width: '100%',
            });

            // Populate select options dynamically
            async function populateSelectOptions(url, selectElement, keys) {
                try {
                    const response = await $.getJSON(url);
                    const options = response.data
                        .map(item => {
                            const displayText = Array.isArray(keys)
                                ? keys.map(key => item[key]).filter(Boolean).join(" (") + ")"
                                : item[keys];
                            return `<option value="${item.id}">${displayText}</option>`;
                        })
                        .join("");
                    $(selectElement).html(options);
                } catch (error) {
                    console.error(`Error populating ${selectElement}:`, error);
                }
            }

            populateSelectOptions(
                "https://pustakam.pythonanywhere.com/category/",
                "#categorySelect",
                ["category_english", "category_hindi"]
            );
            populateSelectOptions(
                "https://pustakam.pythonanywhere.com/author/",
                "#authorSelect",
                ["author_english", "author_hindi"]
            );
            populateSelectOptions(
                "https://pustakam.pythonanywhere.com/languages/",
                "#languageSelect",
                "languages"
            );

            // Custom file input label update
            $(".custom-file-input").on("change", function () {
                const fileName = $(this).prop("files")[0]?.name || "Choose file";
                $(this).next(".custom-file-label").text(fileName);
            });

            // Handle form submission
            $("#bookForm").on("submit", async function (event) {
                event.preventDefault();

                const formData = new FormData(this);

                // Handle multi-select fields: Convert selected options to integers
                formData.set(
                    "author_data",

                    $("#authorSelect")
                        .val()
                        .map(val => parseInt(val, 10))

                );
                formData.set(
                    "category_data",

                    $("#categorySelect")
                        .val()
                        .map(val => parseInt(val, 10))

                );
                formData.set(
                    "language_data",

                    $("#languageSelect")
                        .val()
                        .map(val => parseInt(val, 10))

                );

                // Include free demo percentage
                formData.set("book_free_demo", $("#bookDemoPercent").val());

                // Include book name and details
                formData.set("book_name_english", $("#bookNameEnglish").val());
                formData.set("book_name_hindi", $("#bookNameHindi").val());
                formData.set("book_details_english", $("#bookDetailsEnglish").val());
                formData.set("book_details_hindi", $("#bookDetailsHindi").val());

                // Include book prices
                formData.set("book_price", $("#bookPrice").val());
                formData.set("book_price_discount", $("#bookPriceDiscount").val());

                // Include book files (image and PDF/EPUB)
                const bookFrontImage = $("#bookFrontImage")[0].files[0];
                const bookFile = $("#bookFile")[0].files[0];

                if (bookFrontImage) {
                    formData.set("book_front_image", bookFrontImage);
                }
                if (bookFile) {
                    formData.set("book_file", bookFile);
                }


                try {
                    const response = await fetch(
                        "https://pustakam.pythonanywhere.com/books/",
                        {
                            method: "POST",
                            body: formData,
                        }
                    );

                    const result = await response.json();

                    const message = response.ok
                        ? `<div class="alert alert-success">Book added successfully!</div>`
                        : `<div class="alert alert-danger">Error: ${result.message || "Failed to add book"}</div>`;

                    $("#message").html(message);

                    if (response.ok) {
                        $("#bookForm")[0].reset(); // Reset the form on success
                    }

                    setTimeout(() => $("#message").html(""), 3000); // Clear the message after 3 seconds
                } catch (error) {
                    console.error("Error submitting form:", error);
                    $("#message").html(
                        '<div class="alert alert-danger">An error occurred. Please try again.</div>'
                    );
                    setTimeout(() => $("#message").html(""), 3000);
                }
            });

            // Sync discount price with book price
            $("#useOriginalPrice").on("change", function () {
                const discountInput = $("#bookPriceDiscount");
                if ($(this).is(":checked")) {
                    discountInput.val($("#bookPrice").val()).prop("disabled", true);
                } else {
                    discountInput.prop("disabled", false);
                }
            });

        });
        document.addEventListener("DOMContentLoaded", () => {
            const googleTranslateAPIKey = 'AIzaSyBlk5ZotGsdHMkbjPNarkmr9b3FV5n8vDo';


            // Function to call Google Translate API
            async function translateToHindi(text) {
                const url = `https://translation.googleapis.com/language/translate/v2?key=${googleTranslateAPIKey}`;
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            q: text, // The text to translate
                            source: "en", // Source language
                            target: "hi", // Target language
                            format: "text", // Plain text format
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (
                        data &&
                        data.data &&
                        data.data.translations &&
                        data.data.translations[0]
                    ) {
                        return data.data.translations[0].translatedText;
                    } else {
                        throw new Error("Translation failed. Invalid response structure.");
                    }
                } catch (error) {
                    console.error("Translation API error:", error);
                    return text; // Fallback: return original text if translation fails
                }
            }

            // Debounce function to limit API calls
            function debounce(func, delay) {
                let debounceTimer;
                return function (...args) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // Map English fields to their Hindi counterparts
            const fieldMappings = [
                { englishFieldId: "bookNameEnglish", hindiFieldId: "bookNameHindi" },
                { englishFieldId: "bookDetailsEnglish", hindiFieldId: "bookDetailsHindi" },
                { englishFieldId: "addAuthorEnglish", hindiFieldId: "addAuthorHindi" },
                { englishFieldId: "addCategoryEnglish", hindiFieldId: "addCategoryHindi" },
            ];

            // Set up event listeners for auto-translation
            fieldMappings.forEach(({ englishFieldId, hindiFieldId }) => {
                const englishField = document.getElementById(englishFieldId);
                const hindiField = document.getElementById(hindiFieldId);

                if (englishField && hindiField) {
                    englishField.addEventListener(
                        "input",
                        debounce(async function () {
                            const translatedText = await translateToHindi(englishField.value);
                            hindiField.value = translatedText;
                        }, 500)
                    );
                }
            });












            // load 
        });
        // Function to show the modal
        function addCategoryAndAuther(event, type) {
            event.preventDefault(); // Prevent form submission or default behavior
            if (type === 'category') {
                $('#addCategoryModal').modal('show'); // Show Add Category Modal
            } else if (type === 'auther') {
                $('#addAuthorModal').modal('show'); // Show Add Author Modal
            }
        }

        // Function to populate categories in the dropdown
        async function populateCategoryDropdown() {
            try {
                const response = await fetch("https://pustakam.pythonanywhere.com/category/");
                const data = await response.json();
                const categorySelect = document.getElementById("categorySelect");
                const authorCategorySelect = document.getElementById("authorCategorySelect");

                if (data && data.data) {
                    const options = data.data
                        .map(
                            (category) =>
                                `<option value="${category.id}">${category.category_english} (${category.category_hindi})</option>`
                        )
                        .join("");
                    categorySelect.innerHTML = options; // Populate categories in the book form
                    authorCategorySelect.innerHTML = options; // Populate categories in the Add Author modal
                }
            } catch (error) {
                console.error("Error fetching categories:", error);
                alert("Failed to load categories. Please try again.");
            }
        }

        // Handle Add Category Form Submission
        document.getElementById("addCategoryForm").addEventListener("submit", async function (event) {
            event.preventDefault();
            const categoryEnglish = document.getElementById("addCategoryEnglish").value;
            const categoryHindi = document.getElementById("addCategoryHindi").value;

            try {
                const response = await fetch("https://pustakam.pythonanywhere.com/category/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        category_english: categoryEnglish,
                        category_hindi: categoryHindi,
                    }),
                });

                if (response.ok) {
                    alert("Category added successfully!");
                    document.getElementById("addCategoryForm").reset(); // Clear the form
                    $('#addCategoryModal').modal('hide'); // Close the modal
                    populateCategoryDropdown(); // Reload the category dropdown
                } else {
                    alert("Failed to add category. Please try again.");
                }
            } catch (error) {
                console.error("Error adding category:", error);
                alert("An error occurred. Please try again.");
            }
        });

        // Handle Add Author Form Submission
        document.getElementById("addAuthorForm").addEventListener("submit", async function (event) {
            event.preventDefault();
            const authorEnglish = document.getElementById("addAuthorEnglish").value;
            const authorHindi = document.getElementById("addAuthorHindi").value;
            const categoryId = document.getElementById("authorCategorySelect").value;

            try {
                const response = await fetch("https://pustakam.pythonanywhere.com/author/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        author_english: authorEnglish,
                        author_hindi: authorHindi,
                        category_data: categoryId,
                    }),
                });

                if (response.ok) {
                    alert("Author added successfully!");
                    document.getElementById("addAuthorForm").reset(); // Clear the form
                    $('#addAuthorModal').modal('hide'); // Close the modal
                    populateCategoryDropdown(); // Reload the category dropdown if needed
                } else {
                    alert("Failed to add author. Please try again.");
                }
            } catch (error) {
                console.error("Error adding author:", error);
                alert("An error occurred. Please try again.");
            }
        });

        // Populate categories on page load
        document.addEventListener("DOMContentLoaded", () => {
            populateCategoryDropdown(); // Load categories into dropdowns on page load
        });



    </script>

</body>

</html>